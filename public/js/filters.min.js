$(function () {
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });


    //get data for second page & check the filters as well
    $('body').on('click', '.pagination a', function (e) {
        e.preventDefault();

        var page = $(this).attr('href').split('page=')[1];
        event.preventDefault();

        $('ul.pagination').find('li').removeClass('active');

        $(this).parent('li').addClass('active');

        FilterDonors(page);
    });

    //filter donors based on checkbox
    $('#filters input:checkbox').on('click', function () {
        FilterDonors();
    });
    //filter donors based on checkbox
    $('#is_local:checkbox').on('click', function () {
        FilterDonors();
    });
});


function getFilterOptions(filterBy = 'race') {
    var opts = [];
    var checkboxes = $('#' + filterBy + ' input:checkbox');
    checkboxes.each(function () {
        if (this.checked) {
            opts.push(this.value);
        }
    });
    return opts;
}

function FilterDonors(page = 1) {

    var raceOpts = getFilterOptions('race');
    var hairOpts = getFilterOptions('hair');
    var eyeOpts = getFilterOptions('eyes');

    //return true or false based on checkbox state
    var is_local = !!$('#is_local:checked').val();


    $.ajax({
        url: 'profiles/filter?page=' + page,
        type: 'post',
        data: {
            race: raceOpts,
            hair: hairOpts,
            eye: eyeOpts,
            is_local: is_local
        },
        dataType: "json",
        success: function (response) {

            var data = response.data;

            var donor_html_template = getDonorHtmlTemplate();

            var donor_cards_collection = fillDonorHtmlTemplate(donor_html_template, data);

            if (!donor_cards_collection) {

                $('#donor-cards-row').empty().html(
                    '<div class="alert alert-danger" role="alert">\n' +
                    '  <strong>Oh snap!</strong> Donor Not found, tweak your filters to get specific donors.\n' +
                    '</div>'
                );


                $('ul.pagination').empty();
            } else {

                $('#donor-cards-row').empty().html(donor_cards_collection);
                $('ul.pagination').empty().html(getPaginationLinks(response));
            }

        },
        error: function (response) {

        },
        complete: function () {
        }
    });
}

function getDonorHtmlTemplate() {
    return $('<div class="col-xs-12 col-md-6">' +
        '<div class="wrap text-center">' +
        '<img src="" alt="EGG DONOR" class="img-fluid donor-image">' +
        '<h4>DONOR INFO</h4>' +
        '<ul class="text-left">' +
        '<li class="age">Age <span class="pull-right"></span></li>' +
        '<li class="eyes">Eyes <span class="pull-right"></span></li>' +
        '<li class="cycle">Cycle <span class="pull-right"></span></li>' +
        '</ul>' +
        '<a href="http://ivf1match.test/donor/profile/1" class="btn bttn link-details">More Details</a>' +
        '</div>' +
        '</div>');
}

function getPaginationLinks(response) {

    var prev_page_url = '<li class="page-item disabled">' + '<a href="#" class="page-link">&laquo;</a>' + '</li>';
    var next_page_url = '<li class="page-item disabled">' + '<a href="#" class="page-link">&raquo;</a>' + '</li>';

    var links = '';

    for (i = 1; i <= response.last_page; i++) {

        if (response.current_page === i) {
            links += '<li class="page-item active" aria-current="page"><a href="#" class="page-link">' + i + '</a></li>';
        } else {
            links += '<li class="page-item" aria-current="page" ><a href="' + response.path + '?page=' + i + '" class="page-link">' + i + '</a></li>';
        }
    }

    if (response.prev_page_url !== null) {
        prev_page_url = '<li class="page-item">' + '<a href="' + response.prev_page_url + '" class="page-link">&laquo;</a>' + '</li>';
    }


    if (response.next_page_url !== null) {
        next_page_url = '<li class="page-item">' + '<a href="' + response.next_page_url + '" class="page-link">&raquo;</a>' + '</li>';
    }


    return prev_page_url + links + next_page_url;
}

function fillDonorHtmlTemplate(donorCardHtml, data) {

    var donor_cards_collection = '';

    $.each(data, function (index, value) {
        donorCardHtml.find('.age span').text(value.profile.age);
        donorCardHtml.find('.eyes span').text(value.profile.eye_color);
        donorCardHtml.find('.cycle span').text(value.cycle);

        //if user has given photo permissions
        if (value.profile.photo_permission) {
            var path = getBaseUrl() + '/storage/' + value.images[0].path;
            donorCardHtml.find('img.donor-image').attr('src', path);
        } else {
            donorCardHtml.find('img.donor-image').attr('src', '/img/avatar.png');
        }

        path = getBaseUrl() + '/donor/profile/' + value.id;
        donorCardHtml.find('.link-details').attr('href', path);
        donor_cards_collection += donorCardHtml[0].outerHTML;
    });

    return donor_cards_collection;
}

function getBaseUrl() {
    return window.location.protocol + '//' + window.location.hostname
}
