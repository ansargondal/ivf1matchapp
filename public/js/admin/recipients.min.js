$(function () {

    $body = $('body');


    $('#edit-recipients-form').validate({
        rules: {
            email: {
                required: true
            },
            status: {
                required: true
            }
        }
    });

    //update  recipient status logic
    $body.on('click', '.dropdown .dropdown-menu a', function () {

        var btn = $(this).closest('.dropdown').find('.btn');

        var status = $.trim($(this).text());

        btn.removeClass('dropdown-toggle').addClass('dropdown-loading');

        $.ajax({
            url: btn.data('url'),
            type: 'post',
            data: {status: status},
            dataType: "json",
            success: function (response) {

                if (!response.error) {
                    notify(response.message, response.title);

                    btn.removeClass('dropdown-loading').addClass('dropdown-toggle');
                    btn.text(status).removeClass('btn-danger btn-success btn-warning');

                    updateBtnStatus(btn, status);
                }
            },
            error: function (response) {

            },
            complete: function () {


            }
        });
    });

    //Datatable basic implementation
    var table = $('#data-table').DataTable({

        buttons: ['copy', 'excel', 'pdf'],
        responsive: true,
        processing: true,
        serverSide: true,
        'ajax': '/admin/recipientsAjax',
        'columns': [
            {'data': 'id', name: 'id'},
            {'data': 'fname', name: 'fname'},
            {'data': 'lname', name: 'lname'},
            {'data': 'email', name: 'email'},
            {'data': 'status', name: 'status'},
            {'data': 'action', name: 'action'},
        ],
        "language": {
            processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only"></span>',
            paginate: {
                'previous': '<i class="fa fa-angle-double-left"></i>',
                'next': '<i class="fa fa-angle-double-right"></i>'
            }
        },
    });


    //Data table edit link click (show form and populate data
    var recipientEditModal = $('#edit-recipient-modal');
    var updatePath = '';
    var row = '';

    $body.on('click', '.js-btn-edit', function (evt) {
        evt.preventDefault();

        updatePath = $(this).attr('href');   // route('tasks.update') path
        var editPath = updatePath + '/edit';           // faking  route('tasks.edit');

        row = $(this).parents('tr');

        $.ajax({
            url: editPath,
            type: 'get',
            dataType: 'json',
            success: function (response) {
                recipientEditModal.modal({
                    show: true,
                    keyboard: false,
                    backdrop: 'static'
                });
                addFocusOnOpenModal(recipientEditModal);
                recipientEditModal.find('[name=id]').val(response.id);
                recipientEditModal.find('[name=fname]').val(response.fname);
                recipientEditModal.find('[name=lname]').val(response.lname);
                recipientEditModal.find('[name=status]').val(response.status);
                recipientEditModal.find('[name=email]').val(response.email);
            },
            complete: function () {
            }
        });
    });

    var fname, lname, status;
    $('button#js-btn-update').click(function (evt) {
        evt.preventDefault();

        fname = recipientEditModal.find('[name="fname"]').val();
        lname = recipientEditModal.find('[name="lname"]').val();
        status = recipientEditModal.find('[name="status"]').val();

        var form = $('#form-recipient-update');
        var btn = $(this);

        var data = form.serializeArray();
        data.push({name: '_method', value: 'patch'}); //add patch

        showSpiner(btn);

        $.ajax({
            url: updatePath,
            type: 'post',
            data: data,
            dataType: 'json',
            success: function (response) {
                table.draw();
            },
            complete: function () {
                hideSpinner(btn, 'SAVE');
                recipientEditModal.modal('hide');
            }
        });
    });


    //delete form submission logic
    $body.on('click', 'form #js-btn-delete', function (evt) {
        evt.preventDefault();

        //delete the row from database as well as from table
        destroy(table);
    });

});


function updateBtnStatus(btn, status) {
    switch (status.toLowerCase()) {
        case 'new':
            btn.addClass('btn-danger');
            break;
        case 'active':
            btn.addClass('btn-success');
            break;
        case 'inactive':
            btn.addClass('btn-warning');
            break;
        default:
            break;
    }
}