//password Must be combination of lowercase, uppercase, digits and symbols
$.validator.addMethod("pwcheck", function (value) {
    return /[a-z]/.test(value) // has a lowercase letter
        && /[A-Z]/.test(value) // has a Uppercase letter
        && /\d/.test(value) // has a digit
        && /[\!\@\#\$\%\^\&\*\(\)\-\_\=\+]/.test(value) // has a symbol
});

//clear the quiz age variable when user refresh his browser
localStorage.removeItem('age');

//User Registration Validation
$('#form-user-signup').validate({
    rules: {
        fname: {
            required: true,
            minlength: 2
        },
        lname: {
            required: true,
            minlength: 2
        },
        email: {
            required: true,
            email: true
        },
        password: {
            required: true,
            minlength: 5,
            pwcheck: true
        }
    },
    messages: {
        fname: {
            required: "Please enter your first name.",
            minlength: "First name must have at least 2 characters."
        },
        lname: {
            required: "Please enter your last name.",
            minlength: "Last name must have at least 2 characters."
        },
        email: "Please enter a valid email.",
        password: {
            required: "Please enter your password.",
            minlength: "Password must have 5 at least characters.",
            pwcheck: 'Must be combination of lowercase, uppercase, digits and symbols'
        }
    },

});

$('body').on('click', '#form-user-signup .bttn', function (evt) {
    evt.preventDefault();

    var form = $('#form-user-signup');

    var isValid = form.valid();

    if (isValid) form.submit();
});


$('#form-user-signup').submit(function (evt) {
    evt.preventDefault();

    //remove warning from page
    remove_warning();

    var form = $(this);
    var btn = $(this).find('button.bttn');

    //if validation fails stop form submission
    var isValid = $(this).valid();
    if (!isValid) return false;

    //get the quiz age from local storage(Quiz Form sets it up)
    // and put it in donor sign up form
    $('#quiz-age').val(localStorage.getItem('age'));

    showSpiner(btn);

    $.ajax({
        url: form.attr('action'),
        type: form.attr('method'),
        data: form.serialize(),
        dataType: "json",
        success: function (response) {

            if (!response.error) {

                //check if a recipient submitted form
                var is_recipient_form = url_segment_matches('recipient');

                //reset form (clear data & errors)
                resetForm(form);

                //if form is submitted by recipient
                if (is_recipient_form) {

                    $('#modal-recipient-success').modal({
                        show: true,
                        backdrop: 'static',
                        keyboard: false
                    });

                } else {

                    //give a success message and redirect to donor questionnaire page
                    notify(response.message, response.title);

                    redirect_to('questionnaire');
                }
            } else {

                notify(response.message, response.title, 'fa fa-times text-danger', 'danger');
            }
        },
        error: function (response) {

            //shows errors on appropriate fields
            handleLaravelErrors(response, form);
        },
        complete: function () {
            hideSpinner(btn);
        }
    });
});

function clearFormErrors(form) {

    form.find('.form-group').find('.error').remove();
}

function handleLaravelErrors(response, form) {

    var errors = response.responseJSON.errors;

    clearFormErrors(form);

    $.each(errors, function (key, value) {
        form.find('[name="' + key + '"]').parent('.form-group').append('<span class="error text-danger">' + value + '</span>')

    });
}

//reset form and clear form errors if any
function resetForm(form) {
    clearFormErrors(form);

    form[0].reset();
    form.find('input').trigger('focusout');
    form.find("span.error, label.error").remove();
}

function url_segment_matches(segment) {

    var url_segment = window.location.href.split('/');

    return url_segment.includes(segment);
}



